name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          # Use password auth instead of private key
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            cd /var/www/happyfeet
            # Ensure repo exists; clone if missing
            if [ ! -d .git ]; then
              git clone https://x-access-token:${{ secrets.GIT_TOKEN }}@github.com/kakkadpriyansh/happyfeet.git .
            else
              git remote set-url origin https://x-access-token:${{ secrets.GIT_TOKEN }}@github.com/kakkadpriyansh/happyfeet.git
            fi
            git fetch --all
            git reset --hard origin/main
            # Install deps and build
            if command -v npm >/dev/null 2>&1; then
              npm ci --legacy-peer-deps || npm install --legacy-peer-deps
              npm run build
            else
              echo "npm is not installed on VPS" && exit 1
            fi
            # Restart PM2 app (start if not running)
            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart happyfeet --update-env || pm2 start npm --name happyfeet -- start
              pm2 save
            else
              echo "pm2 is not installed on VPS" && exit 1
            fi